<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Ç–∏—á–Ω–∞ –ë–∏—Ç–≤–∞ (–ö–ª—ñ—î–Ω—Ç)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f9ff; }
        .screen { display: none; flex-direction: column; align-items: center; background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); text-align: center; }
        .screen.active { display: flex; }
        #mode-selection-screen h1 { margin-bottom: 1.5rem; }
        #mode-selection-screen button { margin: 0.5rem; }
        #game-screen { position: relative; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(200, 200, 200, 0.3); z-index: 50; display: none; justify-content: center; align-items: center; font-size: 1.5rem; color: #333; font-weight: bold; border-radius: 1rem; text-align: center; padding: 1rem; pointer-events: none; }
        .overlay.active { display: flex; }
        .grid { display: grid; grid-template-columns: repeat(10, 40px); grid-template-rows: repeat(8, 40px); gap: 1px; background-color: #cbd5e1; border: 1px solid #cbd5e1; margin-bottom: 1rem; position: relative; z-index: 1; }
        .grid-cell { background-color: #e2e8f0; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; position: relative; cursor: pointer; transition: background-color 0.2s ease; pointer-events: auto; }
        .ai-turn-overlay.active ~ #game-grid .grid-cell:hover,
        .deployment-overlay.active ~ #game-grid .grid-cell.deployment-zone:hover { /* –î–æ–∑–≤–æ–ª—è—î–º–æ hover –¥–ª—è –∑–æ–Ω–∏ —Ä–æ–∑—Å—Ç–∞–Ω–æ–≤–∫–∏ */
             /* background-color: #e2e8f0; */ /* –ù–µ –∑–º—ñ–Ω—é—î–º–æ —Ñ–æ–Ω, —è–∫—â–æ —Ü–µ –∑–æ–Ω–∞ —Ä–æ–∑—Å—Ç–∞–Ω–æ–≤–∫–∏ */
             /* cursor: default; */
        }
         .ai-turn-overlay.active ~ #game-grid .grid-cell:not(.deployment-zone):hover {
            background-color: #e2e8f0;
            cursor: default;
        }
        .grid-cell:hover:not(.deployment-zone) { background-color: #bfdbfe; }
        .deployment-zone { background-color: rgba(100, 180, 255, 0.2); outline: 1px dashed #60a5fa; }
        .deployment-zone:hover { background-color: rgba(100, 180, 255, 0.4); }
        .move-highlight { background-color: rgba(0, 255, 0, 0.3) !important; }
        .attack-highlight { background-color: rgba(255, 0, 0, 0.3) !important; }
        .creature { position: absolute; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; transition: transform 0.3s ease, top 0.3s ease, left 0.3s ease; z-index: 10; user-select: none; pointer-events: auto; }
        .creature.selected { transform: scale(1.1); filter: drop-shadow(0 0 5px gold); border: 1px solid gold;}
        .creature .health { position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 0.7rem; padding: 1px 4px; border-radius: 3px; white-space: nowrap; pointer-events: none; }
        .info-panel { display: flex; justify-content: space-between; width: 100%; max-width: 402px; margin-bottom: 1rem; padding: 0.5rem; background-color: #f1f5f9; border-radius: 0.5rem; position: relative; z-index: 60; }
        .info-panel span { font-weight: bold; }
        #deployment-panel { width: 100%; max-width: 402px; margin-bottom: 1rem; padding: 0.5rem; background-color: #e0f2fe; border-radius: 0.5rem; text-align: center; position: relative; z-index: 60; }
        #deployment-panel h3 { margin-bottom: 0.5rem; font-weight: bold;}
        #deployment-creatures-list span { font-size: 1.8rem; margin: 0 0.3rem; cursor: pointer; padding: 2px 5px; border-radius: 4px; transition: background-color 0.2s ease; pointer-events: auto; }
        #deployment-creatures-list span.selected { background-color: #fdba74; }
        #deployment-creatures-list span:hover { background-color: #fed7aa; }
        .message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; display: none; font-size: 0.9rem; pointer-events: none; }
        button { background-color: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s ease; font-weight: bold; position: relative; z-index: 60; pointer-events: auto; }
        button:hover:not(:disabled) { background-color: #2563eb; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #restart-button { background-color: #ef4444; }
        #restart-button:hover:not(:disabled) { background-color: #dc2626; }
    </style>
</head>
<body>
    <div id="mode-selection-screen" class="screen active">
        <h1 class="text-2xl font-bold">–í–∏–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –≥—Ä–∏</h1>
        <button id="pve-button">–ì—Ä–∞–≤–µ—Ü—å –ø—Ä–æ—Ç–∏ –®–Ü</button>
        <button id="pvp-button">–ì—Ä–∞–≤–µ—Ü—å –ø—Ä–æ—Ç–∏ –ì—Ä–∞–≤—Ü—è</button>
    </div>

    <div id="game-screen" class="screen">
         <div id="deployment-overlay" class="overlay">–†–æ–∑—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ñ–π—Å—å–∫...</div>
         <div id="ai-turn-overlay" class="overlay">–•—ñ–¥ –®–Ü...</div>

        <h1 class="text-2xl font-bold mb-4">–¢–∞–∫—Ç–∏—á–Ω–∞ –ë–∏—Ç–≤–∞ (–ö–ª—ñ—î–Ω—Ç)</h1>
        <div id="message-box" class="message-box">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>
        <div class="info-panel">
            <div>–•—ñ–¥: <span id="current-player-text">–ì—Ä–∞–≤–µ—Ü—å 1</span></div>
            <div id="selected-creature-info">–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è</div>
        </div>
        <div id="deployment-panel" style="display: none;">
             <h3 id="deployment-player-text">–ì—Ä–∞–≤–µ—Ü—å 1: –†–æ–∑—Å—Ç–∞–≤—Ç–µ —Å–≤–æ—ó –≤—ñ–π—Å—å–∫–∞</h3>
             <div id="deployment-creatures-list"></div>
             <p class="text-sm mt-2">–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è —ñ –∫–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –≤—ñ–ª—å–Ω—É –∫–ª—ñ—Ç–∏–Ω–∫—É —É –≤–∞—à—ñ–π –∑–æ–Ω—ñ.</p>
        </div>
        <div id="game-grid" class="grid"></div>
        <button id="end-turn-button" class="mt-4" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ö—ñ–¥</button>
         <button id="restart-button" class="mt-2">–ü–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
         <button id="character-page-button" class="mt-2" style="display: none;">–î–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
        <div class="game-info">
            <h2>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≥—Ä—É</h2>
            <p id="current-player">–ü–æ—Ç–æ—á–Ω–∏–π –≥—Ä–∞–≤–µ—Ü—å: <span id="player-name"></span></p>
            <p id="game-mode">–†–µ–∂–∏–º –≥—Ä–∏: <span id="mode-name"></span></p>
            <p id="game-state">–°—Ç–∞–Ω –≥—Ä–∏: <span id="state-name"></span></p>
            <p id="message"></p>
            <div id="player-rating">
                <h3>–†–µ–π—Ç–∏–Ω–≥ –≥—Ä–∞–≤—Ü—è</h3>
                <p>–†–µ–π—Ç–∏–Ω–≥: <span id="rating-value">1000</span></p>
                <p>–ü–µ—Ä–µ–º–æ–≥–∏: <span id="wins-value">0</span></p>
                <p>–ü–æ—Ä–∞–∑–∫–∏: <span id="losses-value">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // --- Creature Types Data ---
        const creature_types_data_client = {
            'knight': {'name': 'knight', 'emoji': '‚ôò', 'maxHp': 20, 'attack': 5, 'movement': 3, 'range': 1},
            'archer': {'name': 'archer', 'emoji': 'üèπ', 'maxHp': 12, 'attack': 4, 'movement': 2, 'range': 4},
            'skeleton': {'name': 'skeleton', 'emoji': 'üíÄ', 'maxHp': 15, 'attack': 3, 'movement': 2, 'range': 1},
            'goblin': {'name': 'goblin', 'emoji': 'üë∫', 'maxHp': 10, 'attack': 2, 'movement': 4, 'range': 1},
        };

        // --- Frontend Configuration ---
        const API_BASE_URL = 'http://127.0.0.1:8000/battle';
        // const API_BASE_URL = 'https://browserstrategy-alpha.onrender.com/battle';
        const GRID_WIDTH = 10;
        const GRID_HEIGHT = 8;
        const CELL_SIZE = 40;
        const DEPLOYMENT_COLUMNS = 3;
        const AI_PLAYER_ID = 2; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –®–Ü

        // --- Frontend State ---
        let currentGameState = {};
        let localSelectedCreatureId = null;
        let localSelectedDeploymentType = null;
        let clientHighlightedCells = []; // –î–ª—è –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ—ó –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏ —Ö–æ–¥—ñ–≤/–∞—Ç–∞–∫

        // --- DOM Elements ---
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameGridElement = document.getElementById('game-grid');
        const currentPlayerTextElement = document.getElementById('current-player-text');
        const selectedCreatureInfoElement = document.getElementById('selected-creature-info');
        const endTurnButton = document.getElementById('end-turn-button');
        const restartButton = document.getElementById('restart-button');
        const messageBox = document.getElementById('message-box');
        const aiTurnOverlay = document.getElementById('ai-turn-overlay');
        const deploymentOverlay = document.getElementById('deployment-overlay');
        const deploymentPanel = document.getElementById('deployment-panel');
        const deploymentPlayerText = document.getElementById('deployment-player-text');
        const deploymentCreaturesList = document.getElementById('deployment-creatures-list');

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Event Listeners for Buttons
            document.getElementById('pve-button').addEventListener('click', () => handleStartGame('pve'));
            document.getElementById('pvp-button').addEventListener('click', () => handleStartGame('pvp'));
            endTurnButton.addEventListener('click', handleEndTurn);
            restartButton.addEventListener('click', handleRestartGame);
            document.getElementById('character-page-button').addEventListener('click', () => {
                window.location.href = '/player';
            });

            // Initial UI Setup
            initializeGridDOM(); // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Å—ñ—Ç–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        });

        // --- API Communication ---
        async function fetchApi(endpoint, method = 'GET', body = null) {
            const options = { 
                method, 
                headers: { 
                    'Content-Type': 'application/json' 
                } 
            };
            // –î–æ–¥–∞—î–º–æ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, —è–∫—â–æ –≤—ñ–Ω —î —É localStorage
            const authToken = localStorage.getItem('authToken'); // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –∫–ª—é—á 'authToken' –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π
            if (authToken) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP error! status: ${response.status}` }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showMessage(`–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É: ${error.message}`, 5000);
                return currentGameState; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–∞—Ä–∏–π —Å—Ç–∞–Ω –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
            }
        }

        // --- UI Update Functions ---
        function updateUI(state) {
            console.log("UI Update with state:", state);
            currentGameState = state;

            currentPlayerTextElement.textContent = getPlayerName(state.currentPlayer);
            if (state.message) showMessage(state.message);

            deploymentPanel.style.display = state.gameState === 'deployment' ? 'block' : 'none';
            endTurnButton.style.display = state.gameState === 'battle' ? 'inline-block' : 'none';
            endTurnButton.disabled = state.gameState !== 'battle' || (state.gameMode === 'pve' && state.currentPlayer === AI_PLAYER_ID);

            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–æ–ª–∏ –≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∞–±–æ –∫–æ–ª–∏ —î –æ–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ –±–æ—ó
            const characterButton = document.getElementById('character-page-button');
            const shouldShowCharacterButton = state.gameState === 'game_over' || 
                (state.message && state.message.includes('–¥–æ—Å—è–≥–ª–∏ –ª—ñ–º—ñ—Ç—É –±–æ—ó–≤'));
            characterButton.style.display = shouldShowCharacterButton ? 'inline-block' : 'none';

            deploymentOverlay.classList.toggle('active', state.gameState === 'deployment');
            if (state.gameState === 'deployment') {
                deploymentOverlay.textContent = `–†–æ–∑—Å—Ç–∞–Ω–æ–≤–∫–∞: ${getPlayerName(state.deploymentPlayer)}`;
                updateDeploymentPanel(state);
                highlightDeploymentZone(state.deploymentPlayer);
            } else {
                clearClientHighlights(); // –û—á–∏—Å—Ç–∏—Ç–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∫—É –∑–æ–Ω, —è–∫—â–æ –Ω–µ —Ä–æ–∑—Å—Ç–∞–Ω–æ–≤–∫–∞
            }

            aiTurnOverlay.classList.toggle('active', state.gameState === 'battle' && state.gameMode === 'pve' && state.currentPlayer === AI_PLAYER_ID);

            renderCreatures(state.creatures);
            updateSelectedCreatureInfo(); // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ñ–æ –ø—Ä–æ –≤–∏–±—Ä–∞–Ω–µ —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è
            
            if (state.gameState === 'game_over') {
                // –î–æ–¥–∞—Ç–∫–æ–≤—ñ –¥—ñ—ó –ø—Ä–∏ –∫—ñ–Ω—Ü—ñ –≥—Ä–∏, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
            }
        }

        function renderCreatures(creaturesData) {
            // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Å—Ç–≤–æ—Ä—ñ–Ω—å
            gameGridElement.querySelectorAll('.creature').forEach(el => el.remove());

            creaturesData.forEach(creature => {
                const div = document.createElement('div');
                div.id = `creature-${creature.id}`;
                div.classList.add('creature', `player${creature.player}`);
                if (creature.id === localSelectedCreatureId) {
                    div.classList.add('selected');
                }
                div.textContent = creature.emoji;
                div.style.left = `${creature.x * CELL_SIZE}px`;
                div.style.top = `${creature.y * CELL_SIZE}px`;
                div.dataset.id = creature.id; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID

                const healthSpan = document.createElement('span');
                healthSpan.classList.add('health');
                healthSpan.textContent = `${creature.hp}/${creature.maxHp}`;
                div.appendChild(healthSpan);

                div.addEventListener('click', (event) => {
                    event.stopPropagation();
                    handleCreatureElementClick(creature); // –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–∞–Ω—ñ —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è
                });
                gameGridElement.appendChild(div);
            });
        }

        function updateDeploymentPanel(state) {
            deploymentPlayerText.textContent = `${getPlayerName(state.deploymentPlayer)}: –†–æ–∑—Å—Ç–∞–≤—Ç–µ —Å–≤–æ—ó –≤—ñ–π—Å—å–∫–∞`;
            const pool = state.deploymentPlayer === 1 ? state.player1DeploymentPool : state.player2DeploymentPool;
            deploymentCreaturesList.innerHTML = '';
            if (!pool) {
                console.warn("Deployment pool is undefined for player:", state.deploymentPlayer);
                return;
            }

            Object.entries(pool).forEach(([typeName, count]) => {
                if (count > 0) {
                    // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ creature_types_data –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ –¥–ª—è emoji
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É, —Å–µ—Ä–≤–µ—Ä –º—ñ–≥ –±–∏ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ emoji —Ä–∞–∑–æ–º –∑ pool
                    const emoji = creature_types_data_client[typeName]?.emoji || '?';
                    const span = document.createElement('span');
                    span.textContent = emoji;
                    span.title = `${typeName} (–ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${count})`;
                    span.dataset.type = typeName;
                    span.classList.toggle('selected', typeName === localSelectedDeploymentType);
                    span.addEventListener('click', () => handleDeploymentCreatureSelect(typeName));
                    deploymentCreaturesList.appendChild(span);
                }
            });
        }

        function updateSelectedCreatureInfo() {
            if (currentGameState.gameState === 'battle' && localSelectedCreatureId) {
                const creature = currentGameState.creatures.find(c => c.id === localSelectedCreatureId);
                if (creature) {
                    selectedCreatureInfoElement.textContent = `–í–∏–±—Ä–∞–Ω–æ: ${creature.emoji} (HP: ${creature.hp}/${creature.maxHp}, –†—É—Ö: ${creature.canMove}, –ê—Ç–∞–∫–∞: ${creature.canAttack})`;
                } else {
                    localSelectedCreatureId = null; // –°–∫–∏–Ω—É—Ç–∏, —è–∫—â–æ —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è –±—ñ–ª—å—à–µ –Ω–µ —ñ—Å–Ω—É—î
                    selectedCreatureInfoElement.textContent = '–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è';
                }
            } else if (currentGameState.gameState === 'deployment') {
                 selectedCreatureInfoElement.textContent = localSelectedDeploymentType ? `–†–æ–∑–º—ñ—Å—Ç–∏—Ç–∏: ${creature_types_data_client[localSelectedDeploymentType]?.emoji || '?'}` : '–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è –¥–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è';
            }
            else {
                selectedCreatureInfoElement.textContent = '–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è';
            }
        }

        // --- Event Handlers ---
        async function handleStartGame(mode) {
            const state = await fetchApi('/start', 'POST', { mode });
            if (state) {
                showScreen('game-screen');
                updateUI(state);
            }
        }

        function handleDeploymentCreatureSelect(typeName) {
            console.log("Client selected deployment type:", typeName);
            localSelectedDeploymentType = typeName;
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–∞–Ω–µ–ª—å —Ä–æ–∑—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
            updateDeploymentPanel(currentGameState);
            updateSelectedCreatureInfo();
        }

        async function handleCellClick(x, y) {
            console.log(`Client cell click: (${x}, ${y}), State: ${currentGameState.gameState}`);
            if (currentGameState.gameState === 'deployment') {
                if (localSelectedDeploymentType) {
                    // –ù–∞–¥—Å–∏–ª–∞—î–º–æ ID –≥—Ä–∞–≤—Ü—è, —â–æ —Ä–æ–∑—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è
                    const playerToDeploy = currentGameState.deploymentPlayer;
                    console.log(`Sending deploy request: Player ${playerToDeploy}, Type ${localSelectedDeploymentType}, Pos (${x},${y})`);
                    const state = await fetchApi(`/deploy?player=${playerToDeploy}&type_name=${localSelectedDeploymentType}&x=${x}&y=${y}`, 'POST');
                    if (state.actionSuccess) {
                        localSelectedDeploymentType = null; // –°–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è
                    }
                    updateUI(state);
                } else {
                    showMessage("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è –¥–ª—è —Ä–æ–∑—Å—Ç–∞–Ω–æ–≤–∫–∏.");
                }
            } else if (currentGameState.gameState === 'battle') {
                if (localSelectedCreatureId) {
                    const selected = currentGameState.creatures.find(c => c.id === localSelectedCreatureId);
                    const targetCreatureOnCell = currentGameState.creatures.find(c => c.x === x && c.y === y);

                    if (targetCreatureOnCell && targetCreatureOnCell.player !== selected.player) {
                        // –°–ø—Ä–æ–±–∞ –∞—Ç–∞–∫–∏ (–∫–ª—ñ–∫ –Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫—É –∑ –≤–æ—Ä–æ–≥–æ–º)
                        console.log(`Client attempting attack from ${localSelectedCreatureId} to ${targetCreatureOnCell.id}`);
                         const state = await fetchApi('/attack', 'POST', { attackerId: localSelectedCreatureId, defenderId: targetCreatureOnCell.id });
                         updateUI(state);
                         if(state.actionSuccess) localSelectedCreatureId = null; // –°–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä –ø—ñ—Å–ª—è –∞—Ç–∞–∫–∏
                    } else if (!targetCreatureOnCell) {
                        // –°–ø—Ä–æ–±–∞ —Ä—É—Ö—É
                        console.log(`Client attempting move for ${localSelectedCreatureId} to (${x},${y})`);
                        const state = await fetchApi(`/move?creature_id=${localSelectedCreatureId}&target_x=${x}&target_y=${y}`, 'POST');
                        updateUI(state);
                        // –ù–µ —Å–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä, —è–∫—â–æ —Ä—É—Ö –≤–¥–∞–≤—Å—è, –∞–ª–µ —â–µ –º–æ–∂–Ω–∞ –∞—Ç–∞–∫—É–≤–∞—Ç–∏ (–ª–æ–≥—ñ–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ)
                        // –ö—Ä–∞—â–µ —Å–∫–∏–¥–∞—Ç–∏ –≤–∏–±—ñ—Ä, —è–∫—â–æ –¥—ñ—è –±—É–ª–∞ —É—Å–ø—ñ—à–Ω–æ—é —ñ —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è –±—ñ–ª—å—à–µ –Ω–µ –º–æ–∂–µ –¥—ñ—è—Ç–∏
                        if (state.actionSuccess) {
                             const movedCreature = state.creatures.find(c => c.id === localSelectedCreatureId);
                             if (movedCreature && !movedCreature.canMove && !movedCreature.canAttack) {
                                 localSelectedCreatureId = null;
                             }
                        }
                    } else {
                        // –ö–ª—ñ–∫ –Ω–∞ —Å–æ—é–∑–Ω–∏–∫–∞ –∞–±–æ –Ω–∞ —Å–µ–±–µ - –∑–Ω—è—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
                        localSelectedCreatureId = null;
                        clearClientHighlights();
                        updateSelectedCreatureInfo();
                        renderCreatures(currentGameState.creatures); // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏ –¥–ª—è –∑–Ω—è—Ç—Ç—è .selected
                    }
                }
            }
        }
        
        function handleCreatureElementClick(creatureData) {
            console.log("Client creature element click:", creatureData);
            if (currentGameState.gameState === 'battle') {
                // –ö–ª—ñ–∫ –Ω–∞ —Å–≤–æ—î —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è –¥–ª—è –≤–∏–±–æ—Ä—É
                if (creatureData.player === currentGameState.currentPlayer) {
                    localSelectedCreatureId = creatureData.id;
                    console.log("Selected creature ID:", localSelectedCreatureId);
                    clearClientHighlights(); // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏
                    // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—Å—å–∫—É –ª–æ–≥—ñ–∫—É –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –º–æ–∂–ª–∏–≤–∏—Ö —Ö–æ–¥—ñ–≤/–∞—Ç–∞–∫
                    // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞–Ω–∏—Ö `creatureData.canMove` —Ç–∞ `creatureData.canAttack`
                    // –¶–µ –∑—Ä–æ–±–∏—Ç—å —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—ñ–ª—å—à –≤—ñ–¥–≥—É–∫–ª–∏–≤–∏–º
                    highlightPossibleActions(creatureData);
                    updateSelectedCreatureInfo();
                    renderCreatures(currentGameState.creatures); // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è .selected
                }
                // –ö–ª—ñ–∫ –Ω–∞ –≤–æ—Ä–æ–∂–µ —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è, —è–∫—â–æ –Ω–∞—à–µ –≤–∏–±—Ä–∞–Ω–µ –¥–ª—è –∞—Ç–∞–∫–∏
                else if (localSelectedCreatureId) {
                    const attacker = currentGameState.creatures.find(c => c.id === localSelectedCreatureId);
                    if (attacker && attacker.canAttack) {
                        console.log(`Client attempting direct attack from ${localSelectedCreatureId} to ${creatureData.id}`);
                        fetchApi(`/attack?attacker_id=${localSelectedCreatureId}&defender_id=${creatureData.id}`, 'POST')
                            .then(state => {
                                updateUI(state);
                                if(state.actionSuccess) localSelectedCreatureId = null;
                            });
                    }
                }
            }
        }

        async function handleEndTurn() {
            if (currentGameState.gameState === 'battle') {
                localSelectedCreatureId = null; // –°–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è–º —Ö–æ–¥—É
                clearClientHighlights();
                const state = await fetchApi('/end_turn', 'POST');
                updateUI(state);
            }
        }

        async function handleRestartGame() {
            localSelectedCreatureId = null;
            localSelectedDeploymentType = null;
            clearClientHighlights();
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –≤–∏–±–æ—Ä—É —Ä–µ–∂–∏–º—É, —Å–µ—Ä–≤–µ—Ä —Å–∫–∏–Ω–µ —Å–≤—ñ–π —Å—Ç–∞–Ω –ø—Ä–∏ /start
            showScreen('mode-selection-screen');
            gameScreen.classList.remove('active'); // –°—Ö–æ–≤–∞—Ç–∏ —ñ–≥—Ä–æ–≤–∏–π –µ–∫—Ä–∞–Ω
            // –û—á–∏—Å—Ç–∏—Ç–∏ —Å—ñ—Ç–∫—É —ñ –ø–∞–Ω–µ–ª—ñ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ
            deploymentPanel.style.display = 'none';
            endTurnButton.style.display = 'none';
            gameGridElement.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏ —Å—ñ—Ç–∫—É –≤—ñ–¥ –∫–ª—ñ—Ç–∏–Ω–æ–∫
            initializeGridDOM(); // –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª—ñ—Ç–∏–Ω–∫–∏ —Å—ñ—Ç–∫–∏
            selectedCreatureInfoElement.textContent = '–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–≤–æ—Ä—ñ–Ω–Ω—è';
            currentPlayerTextElement.textContent = '–ì—Ä–∞–≤–µ—Ü—å 1';

            // –ú–æ–∂–Ω–∞ —Ç–∞–∫–æ–∂ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ /state, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –∫–ª—ñ—î–Ω—Ç —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π,
            // –∞–ª–µ /start –º–∞—î —Å–∫–∏–Ω—É—Ç–∏ –≤—Å–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
            // const state = await fetchApi('/state'); // –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
            // updateUI(state);
        }


        // --- Helper UI Functions ---
        let messageTimeout;
        function showMessage(text, duration = 2500) {
            clearTimeout(messageTimeout);
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            messageTimeout = setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        function showScreen(screenId) {
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –µ–∫—Ä–∞–Ω–∏
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –µ–∫—Ä–∞–Ω
            document.getElementById(screenId).classList.add('active');
        }

        function clearClientHighlights() {
            clientHighlightedCells.forEach(cell => {
                cell.classList.remove('move-highlight', 'attack-highlight', 'deployment-zone');
            });
            clientHighlightedCells = [];
        }

        function highlightDeploymentZone(player) {
            clearClientHighlights();
            const startCol = (player === 1) ? 0 : GRID_WIDTH - DEPLOYMENT_COLUMNS;
            const endCol = startCol + DEPLOYMENT_COLUMNS;
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = startCol; x < endCol; x++) {
                    const cell = gameGridElement.querySelector(`.grid-cell[data-x="${x}"][data-y="${y}"]`);
                    if (cell) { // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –≤—Å—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ –∑–æ–Ω–∏, —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å —á–∏ –≤—ñ–ª—å–Ω–∞
                        cell.classList.add('deployment-zone');
                        clientHighlightedCells.push(cell);
                    }
                }
            }
        }
        
        // –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –º–æ–∂–ª–∏–≤–∏—Ö –¥—ñ–π (–¥–ª—è –∫—Ä–∞—â–æ–≥–æ UX)
        function highlightPossibleActions(creature) {
            clearClientHighlights(); // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ
            if (!creature) return;

            // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ —Ö–æ–¥—ñ–≤
            if (creature.canMove) {
                // –ü—Ä–æ—Å—Ç–∞ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –Ω–∞–≤–∫–æ–ª–æ, —Ä–µ–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
                for (let dx = -creature_types_data_client[creature.type_name].movement; dx <= creature_types_data_client[creature.type_name].movement; dx++) {
                    for (let dy = -creature_types_data_client[creature.type_name].movement; dy <= creature_types_data_client[creature.type_name].movement; dy++) {
                        if (Math.abs(dx) + Math.abs(dy) > creature_types_data_client[creature.type_name].movement || (dx === 0 && dy === 0)) continue;
                        const targetX = creature.x + dx;
                        const targetY = creature.y + dy;
                        if (targetX >= 0 && targetX < GRID_WIDTH && targetY >= 0 && targetY < GRID_HEIGHT) {
                            const cell = gameGridElement.querySelector(`.grid-cell[data-x="${targetX}"][data-y="${targetY}"]`);
                            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –≤—ñ–ª—å–Ω–∞ (–Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ, –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó)
                            const isOccupied = currentGameState.creatures.some(c => c.x === targetX && c.y === targetY);
                            if (cell && !isOccupied) {
                                cell.classList.add('move-highlight');
                                clientHighlightedCells.push(cell);
                            }
                        }
                    }
                }
            }
            // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –∞—Ç–∞–∫
            if (creature.canAttack) {
                 for (let dx = -creature_types_data_client[creature.type_name].range; dx <= creature_types_data_client[creature.type_name].range; dx++) {
                    for (let dy = -creature_types_data_client[creature.type_name].range; dy <= creature_types_data_client[creature.type_name].range; dy++) {
                         if (Math.abs(dx) + Math.abs(dy) > creature_types_data_client[creature.type_name].range || (dx === 0 && dy === 0)) continue;
                        const targetX = creature.x + dx;
                        const targetY = creature.y + dy;
                         if (targetX >= 0 && targetX < GRID_WIDTH && targetY >= 0 && targetY < GRID_HEIGHT) {
                            const cell = gameGridElement.querySelector(`.grid-cell[data-x="${targetX}"][data-y="${targetY}"]`);
                            const targetOnCell = currentGameState.creatures.find(c => c.x === targetX && c.y === targetY);
                            if (cell && targetOnCell && targetOnCell.player !== creature.player) {
                                cell.classList.add('attack-highlight');
                                clientHighlightedCells.push(cell);
                            }
                        }
                    }
                }
            }
        }


        function getPlayerName(playerNumber) {
            if (currentGameState.gameMode === 'pve' && playerNumber === AI_PLAYER_ID) return "–®–Ü";
            if (playerNumber === 1) return currentGameState.playerUsername || "–ì—Ä–∞–≤–µ—Ü—å 1";
            return `–ì—Ä–∞–≤–µ—Ü—å ${playerNumber}`;
        }

        // --- Initial Setup ---
        function initializeGridDOM() {
            gameGridElement.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏, —è–∫—â–æ –≤–∂–µ —î –∫–ª—ñ—Ç–∏–Ω–∫–∏
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.addEventListener('click', () => handleCellClick(x, y));
                    gameGridElement.appendChild(cell);
                }
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É
        async function updateRating() {
            try {
                const response = await fetch('/battle/rating');
                const data = await response.json();
                document.getElementById('rating-value').textContent = data.rating;
                document.getElementById('wins-value').textContent = data.wins;
                document.getElementById('losses-value').textContent = data.losses;
            } catch (error) {
                console.error('Error fetching rating:', error);
            }
        }

        // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', () => {
            updateRating();
        });

        // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–µ–π—Ç–∏–Ω–≥ –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ –±–æ—é
        async function checkGameState() {
            try {
                const response = await fetch('/battle/state');
                const data = await response.json();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                updateUI(data);
                
                // –Ø–∫—â–æ –≥—Ä–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–∞, –æ–Ω–æ–≤–ª—é—î–º–æ —Ä–µ–π—Ç–∏–Ω–≥
                if (data.gameState === 'game_over') {
                    updateRating();
                }
                
                // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —Å—Ç–∞–Ω –≥—Ä–∏
                setTimeout(checkGameState, 1000);
            } catch (error) {
                console.error('Error checking game state:', error);
            }
        }
    </script>
</body>
</html>
