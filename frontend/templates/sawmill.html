{% extends 'base.html' %}

{% block title %}Лісопилка{% endblock %}

{% block body %}
<div class="sawmill-container">
    <!-- Ресурси -->
    <div class="character-resources">
        <span class="resource">
            <img src="../static/images/gold-resource-icon.png" alt="Gold Icon" class="resource-icon"> Золото: {{ user.gold }}
        </span>
        <span class="resource">
            <img src="../static/images/wood-resource-icon.png" alt="Wood Icon" class="resource-icon"> Дерево: {{ user.wood }}
        </span>
    </div>

    <div class="enterprise-image">
        <img src="../static/images/sawmill_model.png" alt="Sawmill" class="sawmill-img">
    </div>

    <div class="sawmill-info">
        <h2>Лісопилка</h2>
        <p>Працівників: {{ enterprise.workers_count }}/{{ enterprise.max_workers }}</p>
        <p>Дерева на складі: {{ enterprise.resource_stored }}/{{ enterprise.max_storage }}</p>
        
        {% if is_working %}
            <p class="status-working">Ви працюєте на лісопилці</p>
            <button onclick="quitWork()" class="quit-btn">Покинути роботу</button>
        {% else %}
            <p class="status-not-working">Ви не працюєте на лісопилці</p>
            {% if not user.workplace %}
                {% if enterprise.workers_count >= enterprise.max_workers %}
                    <p class="warning">Досягнуто максимальної кількості працівників</p>
                {% else %}
                    {% if user.last_quit_time %}
                        <p class="cooldown-timer" id="cooldownTimer"></p>
                    {% endif %}
                    <button onclick="startWork()" class="work-btn" id="workBtn">Влаштуватися на роботу</button>
                {% endif %}
            {% else %}
                <p class="warning">Ви вже працюєте в іншому місці</p>
            {% endif %}
        {% endif %}

        <!-- Додамо форму для введення кількості дерева -->
        <div class="buy-wood-form">
            <input type="number" id="woodAmount" min="1" max="{{ enterprise.resource_stored }}" value="1">
            <button onclick="buyWood()" class="buy-btn" {% if user.gold < 11 or enterprise.resource_stored < 1 %}disabled{% endif %}>
                Купити дерево (11 золота за штуку)
            </button>
        </div>
    </div>

    <div class="navigation-buttons">
        <div class="map-btn">
            <form action="/map" method="get">
                <button type="submit">Повернутися до карти</button>
            </form>
        </div>
    </div>
</div>

<script>
async function startWork() {
    try {
        const response = await fetch(`/enterprise/{{ enterprise.id }}/start-work`, {
            method: 'POST'
        });
        if (response.ok) {
            window.location.reload();
        }
        else if (response.status_code == 400) {
            const error = await response.json();
            alert(error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function quitWork() {
    try {
        const response = await fetch(`/enterprise/{{ enterprise.id }}/quit-work`, {
            method: 'POST'
        });
        const data = await response.json();
        if (response.ok) {
            alert(`Ви заробили ${data.gold_earned} золота!`);
            window.location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function buyWood() {
    const amount = document.getElementById('woodAmount').value;
    try {
        const response = await fetch(`/enterprise/{{ enterprise.id }}/buy-wood`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                amount: parseInt(amount)
            })
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert(error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Додаємо функцію для оновлення таймера
function updateCooldownTimer() {
    const lastQuitTime = new Date("{{ user.last_quit_time }}");
    const now = new Date();
    const cooldownEnd = new Date(lastQuitTime.getTime() + 20000); // 20 секунд в мілісекундах
    
    const timeLeft = cooldownEnd - now;
    const timerElement = document.getElementById('cooldownTimer');
    const workBtn = document.getElementById('workBtn');
    
    if (timeLeft > 0) {
        const secondsLeft = Math.ceil(timeLeft / 1000);
        timerElement.textContent = `Ви зможете влаштуватись через ${secondsLeft} секунд`;
        workBtn.disabled = true;
    } else {
        timerElement.textContent = '';
        workBtn.disabled = false;
    }
}

// Оновлюємо таймер кожні 5 секунд
if (document.getElementById('cooldownTimer')) {
    updateCooldownTimer();
    setInterval(updateCooldownTimer, 5000);
}
</script>
{% endblock %} 