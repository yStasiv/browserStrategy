<!-- <div class="enterprise-actions">
    {% if not user.workplace %}
        <form method="POST" action="/enterprise/{{ enterprise.id }}/work">
            <button type="submit" class="work-btn">Влаштуватися на роботу</button>
        </form>
    {% endif %}

    Додаємо форму для купівлі ресурсів
    <form method="POST" action="/enterprise/{{ enterprise.id }}/buy" class="buy-resources">
        <div class="form-group">
            <label for="amount">Кількість {{ enterprise.resource_type }}:</label>
            <input type="number" id="amount" name="amount" min="1" max="{{ enterprise.resource_stored }}" required>
        </div>
        <p class="price-info">Ціна за одиницю: {{ enterprise.item_price }} золота</p>
        <button type="submit" class="buy-btn">Купити</button>
    </form>
</div>  -->

{% extends 'base.html' %}

{% block title %}{{ enterprise.name }}{% endblock %}

{% block body %}
<div class="enterprise-container">
    <!-- Ресурси -->
    <div class="character-resources">
        <span class="resource">
            <img src="../static/images/gold-resource-icon.png" alt="Gold Icon" class="resource-icon"> Золото: {{ user.gold }}
        </span>
        <span class="resource">
            <img src="../static/images/wood-resource-icon.png" alt="Wood Icon" class="resource-icon"> Дерево: {{ user.wood }}
        </span>
        <span class="resource">
            <img src="../static/images/stone-resourse-icon.png" alt="Stone Icon" class="resource-icon"> Камінь: {{ user.stone }}
        </span>
    </div>

    <div class="enterprise-image">
        {% if enterprise.resource_type == 'wood' %}
            <img src="../static/images/sawmill_model.png" alt="Sawmill" class="sawmill-img">
        {% elif enterprise.resource_type == 'stone' %}
            <img src="../static/images/mine_model.png" alt="Mine" class="sawmill-img">
        {% elif enterprise.resource_type == 'gold' %}
            <img src="../static/images/gold_mine_model.png" alt="Gold Mine" class="sawmill-img">
        {% endif %}
    </div>

    <div class="sawmill-info">
        <h2>{{ enterprise.name }}</h2>
        <p>Сектор підприємства: {{ enterprise.sector}}</p>
        <p>Зарплата на підприємстві: {{ enterprise.salary}} золота за хвилину, або {{ enterprise.salary * 60 }} золота за годину</p>
        <p>Працівників: {{ enterprise.workers_count }}/{{ enterprise.max_workers }}</p>
        <p>{{ enterprise.resource_type }} на складі: {{ enterprise.resource_stored }}/{{ enterprise.max_storage }}</p>
        
        <!-- Додаємо список працівників -->
        <div class="workers-list">
            <h3>Працівники:</h3>
            {% if workers %}
                <div class="workers-preview">
                    {% for worker in workers[:20] %}
                        <a href="/view-character?character_id={{ worker.id }}" class="worker-link">{{ worker.username }}</a>
                    {% endfor %}
                    
                    {% if workers|length > 20 %}
                        <button onclick="showAllWorkers()" class="show-all-btn">
                            Переглянути всіх ({{ workers|length }})
                        </button>
                    {% endif %}
                </div>
                
                <!-- Модальне вікно для повного списку -->
                <div id="workersModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h3>Всі працівники</h3>
                        <div class="full-workers-list">
                            {% for worker in workers %}
                                <a href="/view-character?character_id={{ worker.id }}" class="worker-link">{{ worker.username }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% else %}
                <p class="no-workers">Наразі немає працівників</p>
            {% endif %}
        </div>
        
        {% if user.workplace == "enterprise_" ~ enterprise.id %}
            <p class="status-working">Ви працюєте на підприємстві</p>
            <button onclick="quitWork()" class="quit-btn">Покинути роботу</button>
        {% else %}
            <p class="status-not-working">Ви не працюєте на підприємстві</p>
            {% if not user.workplace %}
                {% if enterprise.workers_count >= enterprise.max_workers %}
                    <p class="warning">Досягнуто максимальної кількості працівників</p>
                {% else %}
                    {% if user.last_quit_time %}
                        <p class="cooldown-timer" id="cooldownTimer"></p>
                    {% endif %}
                    <button onclick="startWork()" class="work-btn" id="workBtn">Влаштуватися на роботу</button>
                {% endif %}
            {% else %}
                <p class="warning">Ви вже працюєте в іншому місці</p>
            {% endif %}
        {% endif %}

        <!-- Додамо форму для введення кількості дерева -->
        <div class="buy-wood-form">
            <form method="POST" action="/enterprise/{{ enterprise.id }}/buy-resources">
                <input type="number" id="amount" name="amount" min="1" max="{{ enterprise.resource_stored }}" value="1">
                <button type="submit" class="buy-btn" {% if user.gold < enterprise.item_price or enterprise.resource_stored < 1 %}disabled{% endif %}>
                    Купити {{ enterprise.resource_type }} ({{ enterprise.item_price }} золота за штуку)
                </button>
            </form>
        </div>
    </div>

    <div class="navigation-buttons">
        <div class="map-btn">
            <form action="/map" method="get">
                <button type="submit">Повернутися до карти</button>
            </form>
        </div>
    </div>
</div>

<script>
async function startWork() {
    try {
        const response = await fetch(`/enterprise/{{ enterprise.id }}/start-work`, {
            method: 'POST'
        });
        if (response.ok) {
            window.location.reload();
        }
        else if (response.status_code == 400) {
            const error = await response.json();
            alert(error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function quitWork() {
    try {
        const response = await fetch(`/enterprise/{{ enterprise.id }}/quit-work`, {
            method: 'POST'
        });
        const data = await response.json();
        if (response.ok) {
            alert(`Ви заробили ${data.gold_earned} золота!`);
            window.location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Додаємо функцію для оновлення таймера
function updateCooldownTimer() {
    const lastQuitTime = new Date("{{ user.last_quit_time }}");
    const now = new Date();
    const cooldownEnd = new Date(lastQuitTime.getTime() + 20000); // 20 секунд в мілісекундах
    
    const timeLeft = cooldownEnd - now;
    const timerElement = document.getElementById('cooldownTimer');
    const workBtn = document.getElementById('workBtn');
    
    if (timeLeft > 0) {
        const secondsLeft = Math.ceil(timeLeft / 1000);
        timerElement.textContent = `Ви зможете влаштуватись через ${secondsLeft} секунд`;
        workBtn.disabled = true;
    } else {
        timerElement.textContent = '';
        workBtn.disabled = false;
    }
}

// Оновлюємо таймер кожні 5 секунд
if (document.getElementById('cooldownTimer')) {
    updateCooldownTimer();
    setInterval(updateCooldownTimer, 5000);
}

// Отримуємо модальне вікно
const modal = document.getElementById("workersModal");
const closeBtn = document.getElementsByClassName("close")[0];

function showAllWorkers() {
    modal.style.display = "block";
}

closeBtn.onclick = function() {
    modal.style.display = "none";
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>
{% endblock %} 